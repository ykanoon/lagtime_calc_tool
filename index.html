<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>観測点までの到達時間ツール</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --panel-w: 360px; }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display: grid; grid-template-columns: var(--panel-w) 1fr; height: 100%; }
    #panel { padding: 12px; border-right: 1px solid #ddd; overflow: auto; }
    #panel h2 { margin: 0 0 8px; font-size: 18px; display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    #panel .hint { color: #555; font-size: 12px; margin: 6px 0 10px; }
    #filters { margin: 8px 0 10px; padding:10px; border:1px solid #eee; border-radius:8px; display:grid; gap:10px; }
    #station-list { display: grid; gap: 6px; max-height: 40vh; overflow: auto; padding: 8px; border: 1px solid #eee; border-radius: 8px; }
    #actions { margin-top: 10px; display: grid; gap: 8px; }
    button { padding: 10px 12px; border: 0; border-radius: 8px; cursor: pointer; font-weight: 600; }
    #showBtn { background: #2563eb; color: #fff; }
    #clearBtn { background: #f1f5f9; }
    #map { width: 100%; height: 100%; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#eef2ff; color:#3730a3; font-size:11px; }
    .popup-table { border-collapse: collapse; font-size: 12px; width:100%; }
    .popup-table td { padding: 2px 6px; border-bottom: 1px solid #eee; }
    .legend { position: absolute; bottom: 12px; left: 12px; background: rgba(255,255,255,0.9); padding: 8px 10px; border-radius: 8px; border:1px solid #ddd; font-size: 12px; }
    #resultBox { margin-top:10px; padding:10px; border:1px solid #eee; border-radius:8px; background:#fafafa; font-size:13px; }
    #resultBox .title { font-weight:700; margin-bottom:6px; display:flex; gap:8px; justify-content:space-between; align-items:center; }
    #swapBtn { background:#e2e8f0; padding:6px 10px; border-radius:8px; border:0; cursor:pointer; font-weight:600; }
    select, option { font-size: 14px; }
  </style>
</head>
<body>
  <div id="app">
    <aside id="panel">
      <h2>
        観測点リスト
        <span class="badge">2点選択</span>
        <span id="countBadge" class="badge" style="display:none"></span>
      </h2>

      <!-- フィルタ：①センター、②火山（ネット） -->
      <div id="filters">
        <label>
          <strong>センター（centerno）</strong><br/>
          <select id="centerSelect" style="margin-top:6px; padding:6px; border-radius:8px; border:1px solid #e5e7eb; width:100%">
            <option value="">（選択してください）</option>
          </select>
        </label>

        <label>
          <strong>火山（kazannet / netnm）</strong><br/>
          <select id="volcanoSelect" disabled style="margin-top:6px; padding:6px; border-radius:8px; border:1px solid #e5e7eb; width:100%">
            <option value="">（センターを先に選択）</option>
          </select>
        </label>

        <span id="filterCount" class="badge" style="display:none"></span>
      </div>

      <div id="station-list">センターと火山を選択してください。</div>

      <div id="actions">
        <button id="showBtn">表示</button>
        <button id="clearBtn">クリア</button>
      </div>

      <!-- 結果（左パネル） -->
      <div id="resultBox">
        <div class="title">
          <span>到達時間（クリック地点）</span>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="swapBtn" disabled title="ch1 と ch2 を入れ替え">ch1 ↔︎ ch2</button>
            <span class="badge" id="resultHint">未計算</span>
          </div>
        </div>
        <div id="resultBody">地図をクリックしてください。</div>
      </div>

      <div class="hint">
        地図クリックで、その地点→選択2観測点の<strong>距離</strong>と
        音速 <b>340 m/s</b> 仮定の到達時間、<b>ch1 − ch2（符号付き）</b> を表示します。
      </div>
      <div class="hint">タイル: 地理院タイル（淡色） / 距離: Leaflet の球面近似</div>
    </aside>

    <div style="position:relative">
      <div id="map"></div>
      <div class="legend">操作: センター → 火山 → 観測点（番号昇順）を2つ選んで「表示」→ 地図をクリック</div>
    </div>
  </div>

  <script>
    // === 定数 ===
    const SPEED = 340.0; // m/s

    // === 地図初期化 ===
    const map = L.map('map', { zoomControl: true }).setView([35.0, 135.0], 5);
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', { attribution: '地理院タイル' }).addTo(map);

    // レイヤー
    const stationLayer = L.layerGroup().addTo(map);
    const linkLayer = L.layerGroup().addTo(map);

    // 状態
    let allStations = [];   // station_all.json 正規化
    let netSansho = [];     // net_sansho.json
    let kazannet = [];      // kazannet.json
    let centerLabels = {};  // centerno_labels.json

    let stationsForVolcano = [];  // 火山（netno）で絞った観測点
    let selected = [];            // 2点まで（順序＝ch1,ch2）
    let lastClickLatLng = null;   // 直近クリック位置（入れ替え時に再計算用）

    // 要素
    const centerSelect  = document.getElementById('centerSelect');
    const volcanoSelect = document.getElementById('volcanoSelect');
    const stationListEl = document.getElementById('station-list');
    const filterCount   = document.getElementById('filterCount');
    const resultBody    = document.getElementById('resultBody');
    const resultHint    = document.getElementById('resultHint');
    const swapBtn       = document.getElementById('swapBtn');

    // 初期化
    init();

    async function init() {
      try {
        // 4つのJSONを読み込み
        const [stRes, relRes, volRes, labRes] = await Promise.all([
          fetch('station_all.json?v=' + Date.now()),
          fetch('net_sansho.json?v=' + Date.now()),
          fetch('kazannet.json?v=' + Date.now()),
          fetch('centerno_labels.json?v=' + Date.now())
        ]);
        if (!stRes.ok || !relRes.ok || !volRes.ok || !labRes.ok) throw new Error('JSON読み込みに失敗');

        const [stRaw, relRaw, volRaw, labRaw] = await Promise.all([
          stRes.json(), relRes.json(), volRes.json(), labRes.json()
        ]);

        // 正規化：stations
        allStations = (Array.isArray(stRaw) ? stRaw : []).map((s, idx) => ({
          id: String(s.kansokutencd ?? s.kansokutenno ?? idx),
          code: s.kansokutencd ?? '',
          number: Number(s.kansokutenno),              // ← 観測点番号（昇順で並べる）
          name: s.kansokutennm ?? '',
          altName: s.siryoukansokutennm ?? '',
          latDec: Number(s.lat),
          lonDec: Number(s.lon),
          hyoukou: Number(s.hyoukou),
          shozokuno: Number(s.shozokuno),
          centerno: Number(s.centerno)
        })).filter(s => Number.isFinite(s.latDec) && Number.isFinite(s.lonDec));

        netSansho = (Array.isArray(relRaw) ? relRaw : []).map(r => ({
          kansokutenno: Number(r.kansokutenno),
          netno: Number(r.netno),
          centerno: Number(r.centerno)
        }));

        kazannet = (Array.isArray(volRaw) ? volRaw : []).map(v => ({
          netno: Number(v.netno),
          netnm: String(v.netnm ?? ''),
          centerno1: Number(v.centerno1)
        }));

        centerLabels = labRaw || {};

        // センタープルダウン構築（centerno昇順、日本語ラベル表示）
        const uniqCenters = [...new Set(allStations.map(s => s.centerno).filter(Number.isFinite))].sort((a,b)=>a-b);
        centerSelect.innerHTML = '<option value="">（選択してください）</option>' +
          uniqCenters.map(cno => `<option value="${cno}">${escapeHtml(centerLabels[String(cno)] ?? ('centerno: '+cno))}</option>`).join('');
        centerSelect.onchange = onCenterChange;

        // 初期UI
        document.getElementById('showBtn').onclick  = onShow;
        document.getElementById('clearBtn').onclick = clearAll;
        map.on('click', onMapClick);
        swapBtn.onclick = onSwap;

        // 件数バッジ
        const countBadge = document.getElementById('countBadge');
        countBadge.textContent = `${allStations.length}件`;
        countBadge.style.display = 'inline-block';

        // 地図中心
        const latAvg = allStations.reduce((a,b)=>a+b.latDec,0)/allStations.length;
        const lonAvg = allStations.reduce((a,b)=>a+b.lonDec,0)/allStations.length;
        if (Number.isFinite(latAvg) && Number.isFinite(lonAvg)) map.setView([latAvg, lonAvg], 10);

      } catch (e) {
        stationListEl.textContent = '初期化に失敗しました。コンソールを確認してください。';
        console.error(e);
      }
    }

    // ① センター変更 → そのセンターに属する火山（kazannet.centerno1）でプルダウン②を更新
    function onCenterChange() {
      clearSelectionAndLayers();
      resultPlaceholder();
      lastClickLatLng = null;
      swapBtn.disabled = true;

      const cval = centerSelect.value;
      const volcanoSelect = document.getElementById('volcanoSelect');
      volcanoSelect.disabled = true;
      volcanoSelect.innerHTML = '<option value="">（センターを先に選択）</option>';

      if (!cval) {
        stationListEl.textContent = 'センターを選んでください。';
        filterCount.style.display = 'none';
        return;
      }

      const cno = Number(cval);

      // センターに属する火山一覧（名前順）
      const volcanoes = kazannet.filter(v => v.centerno1 === cno)
                                .sort((a,b)=>a.netnm.localeCompare(b.netnm, 'ja'));
      if (volcanoes.length === 0) {
        stationListEl.innerHTML = '<span style="color:#b91c1c">このセンターに対応する火山が見つかりません。</span>';
        filterCount.style.display = 'none';
        return;
      }

      volcanoSelect.disabled = true; // 選択させる前に UI 準備
      volcanoSelect.innerHTML = '<option value="">（火山を選択）</option>' +
        volcanoes.map(v => `<option value="${v.netno}">${escapeHtml(v.netnm)}（netno: ${v.netno}）</option>`).join('');
      volcanoSelect.disabled = false;
      volcanoSelect.onchange = () => onVolcanoChange(cno);
      stationListEl.textContent = '火山（ネット）を選んでください。';
      filterCount.style.display = 'none';
    }

    // ② 火山選択 → net_sansho で netno に紐づく kansokutenno を集め、station_all を抽出
    function onVolcanoChange(selectedCenterNo) {
      clearSelectionAndLayers();
      resultPlaceholder();
      lastClickLatLng = null;
      swapBtn.disabled = true;

      const netVal = document.getElementById('volcanoSelect').value;
      if (!netVal) {
        stationListEl.textContent = '火山（ネット）を選んでください。';
        filterCount.style.display = 'none';
        return;
      }
      const netno = Number(netVal);

      // 同センターに属する net_sansho のみ（centernoも一致）
      const kansokutenSet = new Set(
        netSansho.filter(r => r.netno === netno && r.centerno === selectedCenterNo)
                 .map(r => r.kansokutenno)
      );

      stationsForVolcano = allStations
        .filter(s => kansokutenSet.has(s.number))
        .sort((a,b) => a.number - b.number); // ★ 観測点番号（kansokutenno）昇順

      if (stationsForVolcano.length === 0) {
        stationListEl.innerHTML = '<span style="color:#b91c1c">この火山に紐づく観測点が見つかりません。</span>';
        filterCount.style.display = 'none';
        return;
      }

      renderStationList(stationsForVolcano);
      filterCount.textContent = `${stationsForVolcano.length}件`;
      filterCount.style.display = 'inline-block';
    }

    // 観測点リスト描画
    function renderStationList(stations) {
      stationListEl.innerHTML = '';
      stations.forEach(s => {
        const id = 'st-' + s.id;
        const div = document.createElement('div');
        div.innerHTML = `
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="${id}" value="${s.id}">
            <span>${escapeHtml(s.name)}</span>
            <span style="color:#64748b;font-size:11px">(${escapeHtml(s.code)})</span>
            <span class="badge" title="観測点番号">${Number.isFinite(s.number) ? s.number : '-'}</span>
          </label>`;
        const cb = div.querySelector('input');
        cb.addEventListener('change', () => handleCheckChange(cb, s));
        stationListEl.appendChild(div);
      });
    }

    // 選択
    function handleCheckChange(cb, station) {
      if (cb.checked) {
        if (selected.length >= 2) {
          cb.checked = false;
          alert('選択できる観測点は2つまでです。');
          return;
        }
        selected.push(station);
      } else {
        selected = selected.filter(s => s.id !== station.id);
      }
      // 2つそろったら swap 可
      swapBtn.disabled = !(selected.length === 2);
    }

    // 表示（マーカー）
    function onShow() {
      if (selected.length !== 2) { alert('観測点をちょうど2つ選択してください。'); return; }
      stationLayer.clearLayers();
      linkLayer.clearLayers();

      selected.forEach((s, i) => {
        const mk = L.marker([s.latDec, s.lonDec], { title: s.name })
          .bindPopup(`<b>${escapeHtml(s.name)}</b><br>Lat: ${s.latDec.toFixed(5)}<br>Lon: ${s.lonDec.toFixed(5)}`)
          .addTo(stationLayer);
        if (i === 0) mk.openPopup();
      });

      const group = L.featureGroup(selected.map(s => L.marker([s.latDec, s.lonDec])));
      map.fitBounds(group.getBounds().pad(0.25));
    }

    // クリア
    function clearAll() {
      document.querySelectorAll('#station-list input[type="checkbox"]').forEach(cb => cb.checked = false);
      clearSelectionAndLayers();
      resultPlaceholder();
      document.getElementById('volcanoSelect').innerHTML = '<option value="">（センターを先に選択）</option>';
      document.getElementById('volcanoSelect').disabled = true;
      centerSelect.value = '';
      filterCount.style.display = 'none';
      lastClickLatLng = null;
      swapBtn.disabled = true;
    }
    function clearSelectionAndLayers() {
      selected = [];
      stationLayer.clearLayers();
      linkLayer.clearLayers();
    }

    // ch1 ↔︎ ch2 入れ替え
    function onSwap() {
      if (selected.length !== 2) return;
      // 入れ替え
      [selected[0], selected[1]] = [selected[1], selected[0]];
      // 直近クリックがあれば即再計算
      if (lastClickLatLng) {
        recomputeAt(lastClickLatLng);
      } else {
        resultHint.textContent = '未計算';
      }
    }

    // 地図クリック：距離→時間・差（左パネルに表示）
    function onMapClick(e) {
      if (selected.length !== 2) { return; }
      lastClickLatLng = e.latlng; // 記録
      recomputeAt(lastClickLatLng);
    }

    function recomputeAt(p) {
      linkLayer.clearLayers();
      const [ch1, ch2] = selected;

      const r1_dist = L.latLng(p.lat, p.lng).distanceTo([ch1.latDec, ch1.lonDec]);
      const r2_dist = L.latLng(p.lat, p.lng).distanceTo([ch2.latDec, ch2.lonDec]);
      const r1_time = r1_dist / SPEED;
      const r2_time = r2_dist / SPEED;

      L.polyline([[p.lat, p.lng], [ch1.latDec, ch1.lonDec]], { weight: 2, dashArray: '4 4' }).addTo(linkLayer);
      L.polyline([[p.lat, p.lng], [ch2.latDec, ch2.lonDec]], { weight: 2, dashArray: '4 4' }).addTo(linkLayer);

      const dt = r1_time - r2_time; // ch1 - ch2（符号付き）

      const html = `
        <div style="margin-bottom:6px;color:#475569">クリック座標: ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div>
        <table class="popup-table">
          <tr><td>ch1: ${escapeHtml(ch1.name)}</td><td style="text-align:right">${(r1_dist/1000).toFixed(3)} km</td><td style="text-align:right">${r1_time.toFixed(2)} s</td></tr>
          <tr><td>ch2: ${escapeHtml(ch2.name)}</td><td style="text-align:right">${(r2_dist/1000).toFixed(3)} km</td><td style="text-align:right">${r2_time.toFixed(2)} s</td></tr>
          <tr><td style="font-weight:700">ch1 - ch2</td><td colspan="2" style="font-weight:700; text-align:right">${formatSigned(dt)} s</td></tr>
        </table>`;
      showResult(html);
    }

    // 結果表示
    function showResult(html) {
      resultBody.innerHTML = html;
      resultHint.textContent = '更新';
    }
    function resultPlaceholder() {
      resultBody.innerHTML = '地図をクリックしてください。';
      resultHint.textContent = '未計算';
    }

    // ユーティリティ
    function formatSigned(x, digits = 2) {
      const v = Number(x);
      if (!Number.isFinite(v)) return String(x);
      const s = v.toFixed(digits);
      return (v >= 0 ? '+' : '') + s;
    }
    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
  </script>
</body>
</html>

