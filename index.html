<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>観測点までの到達時間ツール</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --panel-w: 340px; }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #app { display: grid; grid-template-columns: var(--panel-w) 1fr; height: 100%; }
    #panel { padding: 12px; border-right: 1px solid #ddd; overflow: auto; }
    #panel h2 { margin: 0 0 8px; font-size: 18px; }
    #panel .hint { color: #555; font-size: 12px; margin: 6px 0 10px; }
    #station-list { display: grid; gap: 6px; max-height: 45vh; overflow: auto; padding: 8px; border: 1px solid #eee; border-radius: 8px; }
    #actions { margin-top: 10px; display: grid; gap: 8px; }
    button { padding: 10px 12px; border: 0; border-radius: 8px; cursor: pointer; font-weight: 600; }
    #showBtn { background: #2563eb; color: #fff; }
    #clearBtn { background: #f1f5f9; }
    #map { width: 100%; height: 100%; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#eef2ff; color:#3730a3; font-size:11px; margin-left:6px; }
    .popup-table { border-collapse: collapse; font-size: 12px; }
    .popup-table td { padding: 2px 6px; border-bottom: 1px solid #eee; }
    .legend { position: absolute; bottom: 12px; left: 12px; background: rgba(255,255,255,0.9); padding: 8px 10px; border-radius: 8px; border:1px solid #ddd; font-size: 12px; }
  </style>
</head>
<body>
  <div id="app">
    <aside id="panel">
      <h2>観測点リスト <span class="badge">2点選択</span></h2>
      <div id="station-list">読み込み中…</div>
      <div id="actions">
        <button id="showBtn">表示</button>
        <button id="clearBtn">クリア</button>
      </div>
      <div class="hint">地図上をクリックすると、その地点→選択した各観測点までの<strong>水平距離</strong>と、音速 <b>340 m/s</b> と仮定した到達時間、および到達時間差をポップアップ表示します。</div>
      <div class="hint">タイル: 地理院地図（淡色） / 測地線距離: Leaflet の球面近似</div>
    </aside>
    <div style="position:relative">
      <div id="map"></div>
      <div class="legend">操作: 観測点を2つ選んで「表示」→地図をクリック</div>
    </div>
  </div>

  <script>
    // === 定数 ===
    const SPEED = 340.0; // m/s

    // === 地図初期化 ===
    const map = L.map('map', { zoomControl: true }).setView([31.90, 130.88], 12);
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      attribution: '地理院タイル'
    }).addTo(map);

    // レイヤー
    const stationLayer = L.layerGroup().addTo(map);
    const linkLayer = L.layerGroup().addTo(map);

    // 状態
    let allStations = []; // [{id,name,lat,lon}]
    let selected = [];    // 選択中 station objects (最大2)

    // === 駅リスト読み込み ===
    init();
    async function init() {
      try {
        const res = await fetch('stations.json');
        if (!res.ok) throw new Error('stations.json の取得に失敗');
        const raw = await res.json();
        // DMS → 十進変換
        allStations = raw.map(s => ({
          ...s,
          latDec: dmsToDec(s.lat),
          lonDec: dmsToDec(s.lon),
        })).filter(s => Number.isFinite(s.latDec) && Number.isFinite(s.lonDec));
        renderStationList(allStations);
        // 地図の初期表示を観測点の重心に
        if (allStations.length) {
          const latAvg = allStations.reduce((a,b)=>a+b.latDec,0)/allStations.length;
          const lonAvg = allStations.reduce((a,b)=>a+b.lonDec,0)/allStations.length;
          map.setView([latAvg, lonAvg], 12);
        }
      } catch (e) {
        document.getElementById('station-list').textContent = '観測点の読み込みに失敗しました。';
        console.error(e);
      }
    }

    function renderStationList(stations) {
      const wrap = document.getElementById('station-list');
      wrap.innerHTML = '';
      stations.forEach(s => {
        const id = 'st-' + s.id;
        const div = document.createElement('div');
        div.innerHTML = `
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="${id}" value="${s.id}">
            <span>${s.name}</span>
            <span style="color:#64748b;font-size:11px">(${s.id})</span>
          </label>`;
        const cb = div.querySelector('input');
        cb.addEventListener('change', () => handleCheckChange(cb, s));
        wrap.appendChild(div);
      });
      document.getElementById('showBtn').addEventListener('click', onShow);
      document.getElementById('clearBtn').addEventListener('click', clearAll);
      map.on('click', onMapClick);
    }

    function handleCheckChange(cb, station) {
      if (cb.checked) {
        if (selected.length >= 2) {
          // 2つまで
          cb.checked = false;
          alert('選択できる観測点は2つまでです。');
          return;
        }
        selected.push(station);
      } else {
        selected = selected.filter(s => s.id !== station.id);
      }
    }

    function onShow() {
      if (selected.length !== 2) { alert('観測点をちょうど2つ選択してください。'); return; }
      stationLayer.clearLayers();
      linkLayer.clearLayers();

      selected.forEach((s, i) => {
        const mk = L.marker([s.latDec, s.lonDec], { title: s.name })
          .bindPopup(`<b>${s.name}</b><br>Lat: ${s.latDec.toFixed(5)}<br>Lon: ${s.lonDec.toFixed(5)}`)
          .addTo(stationLayer);
        if (i === 0) mk.openPopup();
      });
      // bbox フィット
      const group = L.featureGroup(selected.map(s => L.marker([s.latDec, s.lonDec])));
      map.fitBounds(group.getBounds().pad(0.25));
    }

    function clearAll() {
      // チェック解除
      document.querySelectorAll('#station-list input[type="checkbox"]').forEach(cb => cb.checked = false);
      selected = [];
      stationLayer.clearLayers();
      linkLayer.clearLayers();
    }

    function onMapClick(e) {
      if (selected.length !== 2) { return; }
      const p = e.latlng; // クリック点
      linkLayer.clearLayers();

      // クリック → 各観測点の距離&時間
      const rows = selected.map((s, idx) => {
        const dist_m = L.latLng(p.lat, p.lng).distanceTo([s.latDec, s.lonDec]); // m
        const t_s = dist_m / SPEED;
        // 線を引く
        L.polyline([[p.lat, p.lng], [s.latDec, s.lonDec]], { weight: 2, dashArray: '4 4' }).addTo(linkLayer);
        return { name: s.name, id: s.id, dist_m, t_s };
      });

      // 差 [秒]
      const dt = Math.abs(rows[0].t_s - rows[1].t_s);

      const html = `
        <div style="min-width:260px">
          <div style="font-weight:700;margin-bottom:6px">クリック地点からの到達時間</div>
          <table class="popup-table">
            ${rows.map(r => `
              <tr><td>${r.name}</td><td>${(r.dist_m/1000).toFixed(3)} km</td><td>${r.t_s.toFixed(2)} s</td></tr>
            `).join('')}
            <tr><td style="font-weight:700">時間差</td><td colspan="2" style="font-weight:700">${dt.toFixed(2)} s</td></tr>
          </table>
        </div>`;

      L.popup({ closeOnClick: true }).setLatLng(p).setContent(html).openOn(map);
    }

    // "31 53.44" のような "度 分.分" 形式 → 十進
    function dmsToDec(str) {
      if (typeof str !== 'string') return NaN;
      const parts = str.trim().split(/\s+/);
      if (parts.length < 2) return NaN;
      const d = parseFloat(parts[0]);
      const m = parseFloat(parts[1]);
      if (!Number.isFinite(d) || !Number.isFinite(m)) return NaN;
      return d + (m / 60.0);
    }
  </script>
</body>
</html>
